<!doctype html><html lang=zh-CN><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><meta http-equiv=x-ua-compatible content="IE=edge, chrome=1"><title>一个排序问题 - boatrain的博客</title><meta name=Description content="一个排序问题"><meta property="og:title" content="一个排序问题"><meta property="og:description" content="一个排序问题"><meta property="og:type" content="article"><meta property="og:url" content="https://boatrainlsz.github.io/posts/sort-issue/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-09-22T18:09:47+08:00"><meta property="article:modified_time" content="2023-09-22T18:09:47+08:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="一个排序问题"><meta name=twitter:description content="一个排序问题"><meta name=application-name content="boatrain的博客"><meta name=apple-mobile-web-app-title content="boatrain的博客"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=manifest href=/site.webmanifest><link rel=canonical href=https://boatrainlsz.github.io/posts/sort-issue/><link rel=prev href=https://boatrainlsz.github.io/posts/install-clash-on-linux/><link rel=stylesheet href=/lib/normalize/normalize.min.css><link rel=stylesheet href=/css/style.min.css><link rel=stylesheet href=/lib/fontawesome-free/all.min.css><link rel=stylesheet href=/lib/animate/animate.min.css><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"一个排序问题","inLanguage":"zh-CN","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/boatrainlsz.github.io\/posts\/sort-issue\/"},"genre":"posts","keywords":"算法","wordcount":3874,"url":"https:\/\/boatrainlsz.github.io\/posts\/sort-issue\/","datePublished":"2023-09-22T18:09:47+08:00","dateModified":"2023-09-22T18:09:47+08:00","publisher":{"@type":"Organization","name":"boatrain"},"author":{"@type":"Person","name":"boatrain"},"description":"一个排序问题"}</script></head><body header-desktop header-mobile><script type=text/javascript>(window.localStorage&&localStorage.getItem("theme")?localStorage.getItem("theme")==="dark":""==="auto"?window.matchMedia("(prefers-color-scheme: dark)").matches:""==="dark")&&document.body.setAttribute("theme","dark")</script><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title=boatrain的博客>boatrain的博客</a></div><div class=menu><div class=menu-inner><a class=menu-item href=/posts/>文章 </a><a class=menu-item href=/tags/>标签 </a><a class=menu-item href=/categories/>分类 </a><a class=menu-item href=/search/><i class='fas fa-fw fa-search'></i> 搜索 </a><span class="menu-item delimiter"></span><a href=javascript:void(0); class="menu-item theme-switch" title=切换主题>
<i class="fas fa-adjust fa-fw"></i></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title=boatrain的博客>boatrain的博客</a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><a class=menu-item href=/posts/ title>文章</a><a class=menu-item href=/tags/ title>标签</a><a class=menu-item href=/categories/ title>分类</a><a class=menu-item href=/search/ title><i class='fas fa-fw fa-search'></i>搜索</a><a href=javascript:void(0); class="menu-item theme-switch" title=切换主题>
<i class="fas fa-adjust fa-fw"></i></a></div></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=main><div class=container><div class=toc id=toc-auto><h2 class=toc-title>目录</h2><div class=toc-content id=toc-content-auto></div></div><article class="page single"><h1 class="single-title animated flipInX">一个排序问题</h1><div class=post-meta><div class=post-meta-line><span class=post-author><a href=/ title=Author rel=author class=author><i class="fas fa-user-circle fa-fw"></i>boatrain</a></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime=2023-09-22>2023-09-22</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;约 3874 字&nbsp;
<i class="far fa-clock fa-fw"></i>&nbsp;预计阅读 8 分钟&nbsp;</div></div><div class="details toc" id=toc-static kept><div class="details-summary toc-title"><span>目录</span>
<span><i class="details-icon fas fa-angle-right"></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><ul><li><a href=#问题背景>问题背景</a></li><li><a href=#表结构>表结构</a></li><li><a href=#解决方案>解决方案</a></li></ul></li></ul></nav></div></div><div class=content id=content><h3 id=问题背景>问题背景</h3><p>一个项目管理系统，有工作项(issue)，工作项之间有父子关系，父子关系最多有三层，即：祖父->父->子。工作项可以放置在不同的泳道(lane)里，且可以在泳道之间来回拖动，拖动之后，必须在泳道内和它的家族放置在一起。即在同一个泳道内，排序必须遵循如下规则：</p><ol><li>如果有兄弟，则排在最后一个兄弟后面。</li><li>如果没有兄弟，但有父亲，则排在父亲后面。</li><li>如果既没有兄弟，也没有父亲，但有祖父，则排在祖父后面。</li><li>如果祖父也没有，则默认放在泳道的末尾。</li></ol><h3 id=表结构>表结构</h3><h4 id=工作项>工作项</h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>create</span><span class=w> </span><span class=k>table</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=k>not</span><span class=w> </span><span class=k>exists</span><span class=w> </span><span class=n>issue</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>id</span><span class=w>                  </span><span class=nb>varchar</span><span class=p>(</span><span class=mi>64</span><span class=p>)</span><span class=w>  </span><span class=k>not</span><span class=w> </span><span class=k>null</span><span class=w> </span><span class=k>comment</span><span class=w> </span><span class=s1>&#39;UUID&#39;</span><span class=w> </span><span class=k>primary</span><span class=w> </span><span class=k>key</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>title</span><span class=w>               </span><span class=nb>varchar</span><span class=p>(</span><span class=mi>512</span><span class=p>)</span><span class=w> </span><span class=k>not</span><span class=w> </span><span class=k>null</span><span class=w> </span><span class=k>comment</span><span class=w> </span><span class=s1>&#39;标题&#39;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>parent_id</span><span class=w>           </span><span class=nb>varchar</span><span class=p>(</span><span class=mi>64</span><span class=p>)</span><span class=w>  </span><span class=k>null</span><span class=w> </span><span class=k>comment</span><span class=w> </span><span class=s1>&#39;父工作项ID，Epic-&gt;Feature-&gt;Story-&gt;Task-&gt;Subtask，Story-&gt;Bug&#39;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>root_id</span><span class=w>             </span><span class=nb>varchar</span><span class=p>(</span><span class=mi>64</span><span class=p>)</span><span class=w>  </span><span class=k>null</span><span class=w> </span><span class=k>comment</span><span class=w> </span><span class=s1>&#39;根工作项ID，方便查询&#39;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>type</span><span class=w>                </span><span class=nb>varchar</span><span class=p>(</span><span class=mi>320</span><span class=p>)</span><span class=w> </span><span class=k>not</span><span class=w> </span><span class=k>null</span><span class=w> </span><span class=k>comment</span><span class=w> </span><span class=s1>&#39;工作项类型，支持Epic，Feature，Story，Task，Subtask，Bug六种&#39;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>lane_id</span><span class=w>             </span><span class=nb>varchar</span><span class=p>(</span><span class=mi>64</span><span class=p>)</span><span class=w>  </span><span class=k>null</span><span class=w> </span><span class=k>comment</span><span class=w> </span><span class=s1>&#39;泳道ID&#39;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>sort</span><span class=w>                </span><span class=nb>int</span><span class=p>(</span><span class=mi>8</span><span class=p>)</span><span class=w>       </span><span class=k>null</span><span class=w> </span><span class=k>comment</span><span class=w> </span><span class=s1>&#39;排序，工作项在泳道中的排序&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>)</span><span class=w> </span><span class=k>comment</span><span class=w> </span><span class=s1>&#39;工作项&#39;</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></div><h4 id=泳道>泳道</h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>create</span><span class=w> </span><span class=k>table</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=k>not</span><span class=w> </span><span class=k>exists</span><span class=w> </span><span class=n>sprint_lane</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>id</span><span class=w>          </span><span class=nb>varchar</span><span class=p>(</span><span class=mi>64</span><span class=p>)</span><span class=w>  </span><span class=k>not</span><span class=w> </span><span class=k>null</span><span class=w> </span><span class=k>comment</span><span class=w> </span><span class=s1>&#39;UUID&#39;</span><span class=w> </span><span class=k>primary</span><span class=w> </span><span class=k>key</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>name</span><span class=w>        </span><span class=nb>varchar</span><span class=p>(</span><span class=mi>255</span><span class=p>)</span><span class=w> </span><span class=k>not</span><span class=w> </span><span class=k>null</span><span class=w> </span><span class=k>comment</span><span class=w> </span><span class=s1>&#39;名称&#39;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>)</span><span class=w> </span><span class=k>comment</span><span class=w> </span><span class=s1>&#39;迭代泳道&#39;</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></div><h3 id=解决方案>解决方案</h3><h4 id=思路>思路</h4><p>泳道里的工作项实际上组成了一个多叉树，为了处理方便，引入一个虚拟祖先，这样便形成了四层的多叉树结构：
<img class=lazyload src=/svg/loading.min.svg data-src=https://raw.githubusercontent.com/boatrainlsz/my-image-hosting/main/tree.svg data-srcset="https://raw.githubusercontent.com/boatrainlsz/my-image-hosting/main/tree.svg, https://raw.githubusercontent.com/boatrainlsz/my-image-hosting/main/tree.svg 1.5x, https://raw.githubusercontent.com/boatrainlsz/my-image-hosting/main/tree.svg 2x" data-sizes=auto alt=https://raw.githubusercontent.com/boatrainlsz/my-image-hosting/main/tree.svg title=https://raw.githubusercontent.com/boatrainlsz/my-image-hosting/main/tree.svg></p><p>这样一来，排序问题就变成了一个<a href=https://www.geeksforgeeks.org/preorder-traversal-of-a-n-ary-tree/ target=_blank rel="noopener noreffer">多叉树的先序遍历</a>，初始状态下的排序是这样进行的：</p><ol><li>获取整个泳道内的工作项总数，假设总数为 $n_{1}$。</li><li>获取那些不在此泳道内的，但是和此泳道内的工作项有关联的工作项总数，比如子在此泳道内，父却在另一个泳道的。假设这个数字为 $n_{2}$。</li><li>按照总数$n_{1}+n_{2}$，先序遍历泳道内的这棵树，从高到低给工作项们排好序(即设置好sort值)。</li><li>遍历排序完后，把不在此泳道的父与祖issue剔除,再按照sort值重排下。</li></ol><h4 id=代码>代码</h4><h5 id=排序初始化>排序初始化</h5><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl>    <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * @param issuesInLane 待排序的issue列表,可能有有序的+无序的,也可能全是未排序的
</span></span></span><span class=line><span class=cl><span class=cm>     * @return 排序后的issue列表
</span></span></span><span class=line><span class=cl><span class=cm>     */</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=n>List</span><span class=o>&lt;</span><span class=n>Issue</span><span class=o>&gt;</span> <span class=nf>sortIssues</span><span class=o>(</span><span class=n>List</span><span class=o>&lt;</span><span class=n>Issue</span><span class=o>&gt;</span> <span class=n>issuesInLane</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>Set</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span> <span class=n>issueIdsInLane</span> <span class=o>=</span> <span class=n>issuesInLane</span><span class=o>.</span><span class=na>stream</span><span class=o>().</span><span class=na>map</span><span class=o>(</span><span class=n>Issue</span><span class=o>::</span><span class=n>getId</span><span class=o>).</span><span class=na>collect</span><span class=o>(</span><span class=n>Collectors</span><span class=o>.</span><span class=na>toSet</span><span class=o>());</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=n>CollUtil</span><span class=o>.</span><span class=na>isEmpty</span><span class=o>(</span><span class=n>issuesInLane</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>issuesInLane</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm>          遍历issuesInLane，将不在此泳道的祖先也加入到issuesInLane中，便于levelOrder排序，排序完成后再作调整（看下面的removeIf）
</span></span></span><span class=line><span class=cl><span class=cm>          需要递归一层一层往上找，直到找不到parentId为止，所以这里用了while循环，直到tempParentIds为空
</span></span></span><span class=line><span class=cl><span class=cm>          因为光看parentId和rootId还是不够，层级远远不止三层，比如：epic-&gt;feature-&gt;story-&gt;bug
</span></span></span><span class=line><span class=cl><span class=cm>          epic和feature是不需要参与排序的，但是为了确定story和bug的排序，需要将epic和feature也加入到issuesInLane中
</span></span></span><span class=line><span class=cl><span class=cm>          排序完成后再把它们移除，所以看到下面的while循环查询没有加.notIn(Issue::getType, IssueTypeEnum.ISSUE_TYPE_NO_NEED_SORT)这个条件
</span></span></span><span class=line><span class=cl><span class=cm>         */</span>
</span></span><span class=line><span class=cl>        <span class=n>Set</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span> <span class=n>tempParentIds</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>                <span class=n>issuesInLane</span><span class=o>.</span><span class=na>stream</span><span class=o>().</span><span class=na>map</span><span class=o>(</span><span class=n>Issue</span><span class=o>::</span><span class=n>getParentId</span><span class=o>)</span>
</span></span><span class=line><span class=cl>                        <span class=o>.</span><span class=na>filter</span><span class=o>(</span><span class=n>parentId</span> <span class=o>-&gt;</span> <span class=n>StrUtil</span><span class=o>.</span><span class=na>isNotEmpty</span><span class=o>(</span><span class=n>parentId</span><span class=o>)</span> <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=n>issueIdsInLane</span><span class=o>.</span><span class=na>contains</span><span class=o>(</span><span class=n>parentId</span><span class=o>))</span>
</span></span><span class=line><span class=cl>                        <span class=o>.</span><span class=na>collect</span><span class=o>(</span><span class=n>Collectors</span><span class=o>.</span><span class=na>toSet</span><span class=o>());</span>
</span></span><span class=line><span class=cl>        <span class=n>Set</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span> <span class=n>issueIdsNotInLane</span> <span class=o>=</span> <span class=k>new</span> <span class=n>HashSet</span><span class=o>&lt;&gt;(</span><span class=n>tempParentIds</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=k>while</span> <span class=o>(</span><span class=n>CollUtil</span><span class=o>.</span><span class=na>isNotEmpty</span><span class=o>(</span><span class=n>tempParentIds</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>Set</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span> <span class=n>parentIds</span> <span class=o>=</span> <span class=n>issueMapper</span><span class=o>.</span><span class=na>listIssue</span><span class=o>(</span>
</span></span><span class=line><span class=cl>                            <span class=k>new</span> <span class=n>LambdaQueryWrapper</span><span class=o>&lt;</span><span class=n>Issue</span><span class=o>&gt;().</span><span class=na>in</span><span class=o>(</span><span class=n>Issue</span><span class=o>::</span><span class=n>getId</span><span class=o>,</span> <span class=n>tempParentIds</span><span class=o>)).</span><span class=na>stream</span><span class=o>()</span>
</span></span><span class=line><span class=cl>                    <span class=o>.</span><span class=na>map</span><span class=o>(</span><span class=n>Issue</span><span class=o>::</span><span class=n>getParentId</span><span class=o>)</span>
</span></span><span class=line><span class=cl>                    <span class=o>.</span><span class=na>filter</span><span class=o>(</span><span class=n>parentId</span> <span class=o>-&gt;</span> <span class=n>StrUtil</span><span class=o>.</span><span class=na>isNotEmpty</span><span class=o>(</span><span class=n>parentId</span><span class=o>)</span> <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=n>issueIdsInLane</span><span class=o>.</span><span class=na>contains</span><span class=o>(</span><span class=n>parentId</span><span class=o>))</span>
</span></span><span class=line><span class=cl>                    <span class=o>.</span><span class=na>collect</span><span class=o>(</span><span class=n>Collectors</span><span class=o>.</span><span class=na>toSet</span><span class=o>());</span>
</span></span><span class=line><span class=cl>            <span class=n>issueIdsNotInLane</span><span class=o>.</span><span class=na>addAll</span><span class=o>(</span><span class=n>parentIds</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=n>tempParentIds</span> <span class=o>=</span> <span class=n>parentIds</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=n>CollUtil</span><span class=o>.</span><span class=na>isNotEmpty</span><span class=o>(</span><span class=n>issueIdsNotInLane</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>List</span><span class=o>&lt;</span><span class=n>Issue</span><span class=o>&gt;</span> <span class=n>issuesNotInLane</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>                    <span class=n>issueMapper</span><span class=o>.</span><span class=na>listIssue</span><span class=o>(</span><span class=k>new</span> <span class=n>LambdaQueryWrapper</span><span class=o>&lt;</span><span class=n>Issue</span><span class=o>&gt;().</span><span class=na>in</span><span class=o>(</span><span class=n>Issue</span><span class=o>::</span><span class=n>getId</span><span class=o>,</span> <span class=n>issueIdsNotInLane</span><span class=o>));</span>
</span></span><span class=line><span class=cl>            <span class=n>issuesInLane</span><span class=o>.</span><span class=na>addAll</span><span class=o>(</span><span class=n>issuesNotInLane</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=c1>//按父分类,key为父id，value为子issue列表
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>Map</span><span class=o>&lt;</span><span class=n>Optional</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;,</span> <span class=n>List</span><span class=o>&lt;</span><span class=n>Issue</span><span class=o>&gt;&gt;</span> <span class=n>parentChildRel</span> <span class=o>=</span> <span class=n>issuesInLane</span><span class=o>.</span><span class=na>stream</span><span class=o>().</span><span class=na>filter</span><span class=o>(</span><span class=n>Objects</span><span class=o>::</span><span class=n>nonNull</span><span class=o>)</span>
</span></span><span class=line><span class=cl>                <span class=c1>//Optional.empty()表示一个虚拟的祖先,本来只有三层,为了后续树的遍历方便,增加一个虚拟祖先,变成了:孙-&gt;子-&gt;父-&gt;虚拟祖先
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=c1>//因为groupingBy不允许null key
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=c1>//不允许null key，用Optional包装一下，以前这里用-1，后面保存数据库时还要重新设置为null，多了一次遍历的开销，
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=o>.</span><span class=na>collect</span><span class=o>(</span><span class=n>Collectors</span><span class=o>.</span><span class=na>groupingBy</span><span class=o>(</span><span class=n>issue</span> <span class=o>-&gt;</span> <span class=n>Optional</span><span class=o>.</span><span class=na>ofNullable</span><span class=o>(</span><span class=n>issue</span><span class=o>.</span><span class=na>getParentId</span><span class=o>())));</span>
</span></span><span class=line><span class=cl>        <span class=n>Map</span><span class=o>&lt;</span><span class=n>Optional</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;,</span> <span class=n>Issue</span><span class=o>&gt;</span> <span class=n>issueMap</span> <span class=o>=</span> <span class=n>issuesInLane</span><span class=o>.</span><span class=na>stream</span><span class=o>().</span><span class=na>filter</span><span class=o>(</span><span class=n>Objects</span><span class=o>::</span><span class=n>nonNull</span><span class=o>)</span>
</span></span><span class=line><span class=cl>                <span class=o>.</span><span class=na>collect</span><span class=o>(</span><span class=n>Collectors</span><span class=o>.</span><span class=na>toMap</span><span class=o>(</span><span class=n>issue</span> <span class=o>-&gt;</span> <span class=n>Optional</span><span class=o>.</span><span class=na>ofNullable</span><span class=o>(</span><span class=n>issue</span><span class=o>.</span><span class=na>getId</span><span class=o>()),</span> <span class=n>Function</span><span class=o>.</span><span class=na>identity</span><span class=o>()));</span>
</span></span><span class=line><span class=cl>        <span class=c1>//注意这里的排序是同一级的排序,也就是兄弟间的排序,不涉及父子,父子关系的体现在下面的levelOrder方法中
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>for</span> <span class=o>(</span><span class=n>List</span><span class=o>&lt;</span><span class=n>Issue</span><span class=o>&gt;</span> <span class=n>siblings</span> <span class=o>:</span> <span class=n>parentChildRel</span><span class=o>.</span><span class=na>values</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>siblings</span><span class=o>.</span><span class=na>sort</span><span class=o>((</span><span class=n>issue1</span><span class=o>,</span> <span class=n>issue2</span><span class=o>)</span> <span class=o>-&gt;</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=o>(</span><span class=n>issue1</span><span class=o>.</span><span class=na>getSort</span><span class=o>()</span> <span class=o>==</span> <span class=kc>null</span> <span class=o>||</span> <span class=n>issue2</span><span class=o>.</span><span class=na>getSort</span><span class=o>()</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=c1>//只要有一个sort为空，则按照sequence排序
</span></span></span><span class=line><span class=cl><span class=c1></span>                    <span class=k>return</span> <span class=n>issue2</span><span class=o>.</span><span class=na>getSequence</span><span class=o>().</span><span class=na>compareTo</span><span class=o>(</span><span class=n>issue1</span><span class=o>.</span><span class=na>getSequence</span><span class=o>());</span>
</span></span><span class=line><span class=cl>                <span class=o>}</span>
</span></span><span class=line><span class=cl>                <span class=c1>//两个都有序,按照原来的sort排序
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=k>return</span> <span class=n>issue2</span><span class=o>.</span><span class=na>getSort</span><span class=o>().</span><span class=na>compareTo</span><span class=o>(</span><span class=n>issue1</span><span class=o>.</span><span class=na>getSort</span><span class=o>());</span>
</span></span><span class=line><span class=cl>            <span class=o>});</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=c1>//树的先序遍历
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>AtomicInteger</span> <span class=n>counter</span> <span class=o>=</span> <span class=k>new</span> <span class=n>AtomicInteger</span><span class=o>(</span><span class=n>issuesInLane</span><span class=o>.</span><span class=na>size</span><span class=o>());</span>
</span></span><span class=line><span class=cl>        <span class=n>List</span><span class=o>&lt;</span><span class=n>Issue</span><span class=o>&gt;</span> <span class=n>result</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ArrayList</span><span class=o>&lt;&gt;();</span>
</span></span><span class=line><span class=cl>        <span class=c1>//Optional.empty()表示虚拟的祖先
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>preOrder</span><span class=o>(</span><span class=n>Optional</span><span class=o>.</span><span class=na>empty</span><span class=o>(),</span> <span class=n>result</span><span class=o>,</span> <span class=n>parentChildRel</span><span class=o>,</span> <span class=n>issueMap</span><span class=o>,</span> <span class=n>counter</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=c1>//遍历排序完后，把不在此泳道的父与祖issue剔除,再按照sort值重排下
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>result</span><span class=o>.</span><span class=na>removeIf</span><span class=o>(</span><span class=n>issue</span> <span class=o>-&gt;</span> <span class=n>issueIdsNotInLane</span><span class=o>.</span><span class=na>contains</span><span class=o>(</span><span class=n>issue</span><span class=o>.</span><span class=na>getId</span><span class=o>()));</span>
</span></span><span class=line><span class=cl>        <span class=n>result</span><span class=o>.</span><span class=na>sort</span><span class=o>(</span><span class=n>Comparator</span><span class=o>.</span><span class=na>comparingInt</span><span class=o>(</span><span class=n>Issue</span><span class=o>::</span><span class=n>getSort</span><span class=o>).</span><span class=na>reversed</span><span class=o>());</span>
</span></span><span class=line><span class=cl>        <span class=n>AtomicInteger</span> <span class=n>pureSort</span> <span class=o>=</span> <span class=k>new</span> <span class=n>AtomicInteger</span><span class=o>(</span><span class=n>result</span><span class=o>.</span><span class=na>size</span><span class=o>());</span>
</span></span><span class=line><span class=cl>        <span class=n>result</span><span class=o>.</span><span class=na>forEach</span><span class=o>(</span><span class=n>issue</span> <span class=o>-&gt;</span> <span class=n>issue</span><span class=o>.</span><span class=na>setSort</span><span class=o>(</span><span class=n>pureSort</span><span class=o>.</span><span class=na>getAndDecrement</span><span class=o>()));</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>result</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>//多叉树的先序遍历
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>//                      NULL
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>//                     / | \
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>//                    /  |   \
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>//                  2    3     4
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>//                 / \       / | \
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>//                5    6    7  8  9
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>//               /   / | \
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>//              10  11 12 13
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>    <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * preOrder的遍历顺序是NULL 2 5 10 6 11 12 13 3 4 7 8 9
</span></span></span><span class=line><span class=cl><span class=cm>     * 排sort
</span></span></span><span class=line><span class=cl><span class=cm>     *
</span></span></span><span class=line><span class=cl><span class=cm>     * @param rootIssueId    树的根节点
</span></span></span><span class=line><span class=cl><span class=cm>     * @param result         返回排好序的结果
</span></span></span><span class=line><span class=cl><span class=cm>     * @param parentChildRel 父子关系，key为父id，value为儿子的集合
</span></span></span><span class=line><span class=cl><span class=cm>     * @param issueMap       所有issue的map，key为issueId，value为issue
</span></span></span><span class=line><span class=cl><span class=cm>     * @param counter        计数器，用于给每个issue的sort赋值，从高到低递减
</span></span></span><span class=line><span class=cl><span class=cm>     * @see &lt;a href=&#34;https://www.geeksforgeeks.org/iterative-preorder-traversal-of-a-n-ary-tree/&#34;&gt;多叉树的先序遍历&lt;/a&gt;
</span></span></span><span class=line><span class=cl><span class=cm>     */</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>preOrder</span><span class=o>(</span><span class=n>Optional</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span> <span class=n>rootIssueId</span><span class=o>,</span> <span class=n>List</span><span class=o>&lt;</span><span class=n>Issue</span><span class=o>&gt;</span> <span class=n>result</span><span class=o>,</span>
</span></span><span class=line><span class=cl><span class=n>Map</span><span class=o>&lt;</span><span class=n>Optional</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;,</span> <span class=n>List</span><span class=o>&lt;</span><span class=n>Issue</span><span class=o>&gt;&gt;</span> <span class=n>parentChildRel</span><span class=o>,</span>
</span></span><span class=line><span class=cl><span class=n>Map</span><span class=o>&lt;</span><span class=n>Optional</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;,</span> <span class=n>Issue</span><span class=o>&gt;</span> <span class=n>issueMap</span><span class=o>,</span> <span class=n>AtomicInteger</span> <span class=n>counter</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>//虚拟祖先为Optional.empty(),不要加进去
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>if</span> <span class=o>(</span><span class=n>rootIssueId</span><span class=o>.</span><span class=na>isPresent</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>Issue</span> <span class=n>issue</span> <span class=o>=</span> <span class=n>issueMap</span><span class=o>.</span><span class=na>get</span><span class=o>(</span><span class=n>rootIssueId</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=n>issue</span><span class=o>.</span><span class=na>setSort</span><span class=o>(</span><span class=n>counter</span><span class=o>.</span><span class=na>getAndDecrement</span><span class=o>());</span>
</span></span><span class=line><span class=cl>            <span class=n>result</span><span class=o>.</span><span class=na>add</span><span class=o>(</span><span class=n>issue</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=n>List</span><span class=o>&lt;</span><span class=n>Issue</span><span class=o>&gt;</span> <span class=n>children</span> <span class=o>=</span> <span class=n>parentChildRel</span><span class=o>.</span><span class=na>get</span><span class=o>(</span><span class=n>rootIssueId</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=n>CollUtil</span><span class=o>.</span><span class=na>isEmpty</span><span class=o>(</span><span class=n>children</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=o>(</span><span class=n>Issue</span> <span class=n>child</span> <span class=o>:</span> <span class=n>children</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>preOrder</span><span class=o>(</span><span class=n>Optional</span><span class=o>.</span><span class=na>of</span><span class=o>(</span><span class=n>child</span><span class=o>.</span><span class=na>getId</span><span class=o>()),</span> <span class=n>result</span><span class=o>,</span> <span class=n>parentChildRel</span><span class=o>,</span> <span class=n>issueMap</span><span class=o>,</span> <span class=n>counter</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span></code></pre></div><h5 id=跨泳道拖动排序>跨泳道拖动排序</h5><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Data</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>CrossLaneIssueSortVo</span> <span class=kd>extends</span> <span class=n>BaseVo</span> <span class=kd>implements</span> <span class=n>Serializable</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kd>static</span> <span class=kd>final</span> <span class=kt>long</span> <span class=n>serialVersionUID</span> <span class=o>=</span> <span class=n>1L</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@NotEmpty</span><span class=o>(</span><span class=n>message</span> <span class=o>=</span> <span class=s>&#34;项目ID&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=n>String</span> <span class=n>projectId</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@NotEmpty</span><span class=o>(</span><span class=n>message</span> <span class=o>=</span> <span class=s>&#34;工作项ID&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=n>String</span> <span class=n>issueId</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@NotEmpty</span><span class=o>(</span><span class=n>message</span> <span class=o>=</span> <span class=s>&#34;目标泳道ID&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=n>String</span> <span class=n>targetLaneId</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@NotEmpty</span><span class=o>(</span><span class=n>message</span> <span class=o>=</span> <span class=s>&#34;原泳道ID&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=n>String</span> <span class=n>sourceLaneId</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl>    <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 跨泳道工作项排序
</span></span></span><span class=line><span class=cl><span class=cm>     * 1.如果目标泳道内没有该issue的家族（家族指的是父、子、孙、兄），则放到泳道最下面
</span></span></span><span class=line><span class=cl><span class=cm>     * 2.如果存在家族，则和家族放一起，家族的最后一个，即：有兄弟，放兄弟最后，有父亲，无兄弟，放父后面，无兄弟，无父亲，挂在祖父后面。
</span></span></span><span class=line><span class=cl><span class=cm>     * 总而言之，要和家族聚集在一起
</span></span></span><span class=line><span class=cl><span class=cm>     * @param vo
</span></span></span><span class=line><span class=cl><span class=cm>     */</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kt>void</span> <span class=nf>sortIssueCrossLane</span><span class=o>(</span><span class=n>CrossLaneIssueSortVo</span> <span class=n>vo</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>//跨泳道拖动只会拖一个,不考虑父子关系
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm>          将工作项拖动到 新泳道后，默认排在该”泳道“的最后一个。
</span></span></span><span class=line><span class=cl><span class=cm>          无论该泳道有几个 状态，也无论拖进哪个状态框，
</span></span></span><span class=line><span class=cl><span class=cm>          拖过去后默认直接排在该泳道的最后一个即可
</span></span></span><span class=line><span class=cl><span class=cm>          （特殊情况：存在父子关系的工作项，子工作项始终排在父工作项下）
</span></span></span><span class=line><span class=cl><span class=cm>          源泳道的工作项排序需要更新,大于此issue的全-1
</span></span></span><span class=line><span class=cl><span class=cm>          调用此接口前,前端已经调用了updateIssue接口更新了issue状态,也就是说逻辑上,此时这个issue已经在新泳道了,只不过它的sort还没有更新
</span></span></span><span class=line><span class=cl><span class=cm>         */</span>
</span></span><span class=line><span class=cl>        <span class=n>String</span> <span class=n>targetLaneId</span> <span class=o>=</span> <span class=n>vo</span><span class=o>.</span><span class=na>getTargetLaneId</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>SprintLane</span> <span class=n>targetLane</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>                <span class=n>sprintLaneMapper</span><span class=o>.</span><span class=na>selectOne</span><span class=o>(</span><span class=k>new</span> <span class=n>LambdaQueryWrapper</span><span class=o>&lt;</span><span class=n>SprintLane</span><span class=o>&gt;().</span><span class=na>eq</span><span class=o>(</span><span class=n>SprintLane</span><span class=o>::</span><span class=n>getId</span><span class=o>,</span> <span class=n>targetLaneId</span><span class=o>));</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=n>Objects</span><span class=o>.</span><span class=na>isNull</span><span class=o>(</span><span class=n>targetLane</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>ExceptionUtils</span><span class=o>.</span><span class=na>validParamException</span><span class=o>(</span><span class=n>targetLaneId</span><span class=o>,</span> <span class=s>&#34;targetLaneId&#34;</span><span class=o>,</span> <span class=n>HttpStatus</span><span class=o>.</span><span class=na>NOT_FOUND</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                    <span class=n>ProjectsExceptionCode</span><span class=o>.</span><span class=na>INVALID_SPRINT_LANE_NOTFOUND</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=n>String</span> <span class=n>sourceLaneId</span> <span class=o>=</span> <span class=n>vo</span><span class=o>.</span><span class=na>getSourceLaneId</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>SprintLane</span> <span class=n>sourceLane</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>                <span class=n>sprintLaneMapper</span><span class=o>.</span><span class=na>selectOne</span><span class=o>(</span><span class=k>new</span> <span class=n>LambdaQueryWrapper</span><span class=o>&lt;</span><span class=n>SprintLane</span><span class=o>&gt;().</span><span class=na>eq</span><span class=o>(</span><span class=n>SprintLane</span><span class=o>::</span><span class=n>getId</span><span class=o>,</span> <span class=n>sourceLaneId</span><span class=o>));</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=n>Objects</span><span class=o>.</span><span class=na>isNull</span><span class=o>(</span><span class=n>sourceLane</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>ExceptionUtils</span><span class=o>.</span><span class=na>validParamException</span><span class=o>(</span><span class=n>sourceLaneId</span><span class=o>,</span> <span class=s>&#34;sourceLaneId&#34;</span><span class=o>,</span> <span class=n>HttpStatus</span><span class=o>.</span><span class=na>NOT_FOUND</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                    <span class=n>ProjectsExceptionCode</span><span class=o>.</span><span class=na>INVALID_SPRINT_LANE_NOTFOUND</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=n>String</span> <span class=n>issueId</span> <span class=o>=</span> <span class=n>vo</span><span class=o>.</span><span class=na>getIssueId</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>Issue</span> <span class=n>issue</span> <span class=o>=</span> <span class=n>issueService</span><span class=o>.</span><span class=na>getById</span><span class=o>(</span><span class=n>issueId</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=n>Objects</span><span class=o>.</span><span class=na>isNull</span><span class=o>(</span><span class=n>issue</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>ExceptionUtils</span><span class=o>.</span><span class=na>validParamException</span><span class=o>(</span><span class=n>issueId</span><span class=o>,</span> <span class=s>&#34;issueId&#34;</span><span class=o>,</span> <span class=n>HttpStatus</span><span class=o>.</span><span class=na>NOT_FOUND</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                    <span class=n>ProjectsExceptionCode</span><span class=o>.</span><span class=na>INVALID_ISSUE_NOT_FOUND</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=n>String</span> <span class=n>sprintId</span> <span class=o>=</span> <span class=n>issue</span><span class=o>.</span><span class=na>getSprintId</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>String</span> <span class=n>projectId</span> <span class=o>=</span> <span class=n>vo</span><span class=o>.</span><span class=na>getProjectId</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>Set</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span> <span class=n>stateIdsInTargetLane</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>                <span class=n>Arrays</span><span class=o>.</span><span class=na>stream</span><span class=o>(</span><span class=n>targetLane</span><span class=o>.</span><span class=na>getStateIds</span><span class=o>().</span><span class=na>split</span><span class=o>(</span><span class=s>&#34;,&#34;</span><span class=o>)).</span><span class=na>collect</span><span class=o>(</span><span class=n>Collectors</span><span class=o>.</span><span class=na>toSet</span><span class=o>());</span>
</span></span><span class=line><span class=cl>        <span class=n>List</span><span class=o>&lt;</span><span class=n>Issue</span><span class=o>&gt;</span> <span class=n>issuesInTargetLane</span> <span class=o>=</span> <span class=n>issueMapper</span><span class=o>.</span><span class=na>listIssue</span><span class=o>(</span>
</span></span><span class=line><span class=cl>                <span class=k>new</span> <span class=n>LambdaQueryWrapper</span><span class=o>&lt;</span><span class=n>Issue</span><span class=o>&gt;().</span><span class=na>in</span><span class=o>(</span><span class=n>Issue</span><span class=o>::</span><span class=n>getStateId</span><span class=o>,</span> <span class=n>stateIdsInTargetLane</span><span class=o>)</span>
</span></span><span class=line><span class=cl>                        <span class=o>.</span><span class=na>in</span><span class=o>(</span><span class=n>Issue</span><span class=o>::</span><span class=n>getProjectId</span><span class=o>,</span> <span class=n>projectId</span><span class=o>).</span><span class=na>notIn</span><span class=o>(</span><span class=n>Issue</span><span class=o>::</span><span class=n>getType</span><span class=o>,</span> <span class=n>IssueTypeEnum</span><span class=o>.</span><span class=na>ISSUE_TYPE_NO_NEED_SORT</span><span class=o>)</span>
</span></span><span class=line><span class=cl>                        <span class=c1>//eq是不为null的情况，isNotNull是为null的情况
</span></span></span><span class=line><span class=cl><span class=c1></span>                        <span class=o>.</span><span class=na>eq</span><span class=o>(</span><span class=n>StrUtil</span><span class=o>.</span><span class=na>isNotEmpty</span><span class=o>(</span><span class=n>sprintId</span><span class=o>),</span> <span class=n>Issue</span><span class=o>::</span><span class=n>getSprintId</span><span class=o>,</span> <span class=n>sprintId</span><span class=o>)</span>
</span></span><span class=line><span class=cl>                        <span class=o>.</span><span class=na>isNull</span><span class=o>(</span><span class=n>StrUtil</span><span class=o>.</span><span class=na>isEmpty</span><span class=o>(</span><span class=n>sprintId</span><span class=o>),</span> <span class=n>Issue</span><span class=o>::</span><span class=n>getSprintId</span><span class=o>)</span>
</span></span><span class=line><span class=cl>                        <span class=c1>//排除掉自己，因为调用此接口前,前端已经调用了updateIssue接口更新了issue状态,也就是说逻辑上,此时这个issue已经在targetLane了,只不过它的sort还没有更新
</span></span></span><span class=line><span class=cl><span class=c1></span>                        <span class=o>.</span><span class=na>ne</span><span class=o>(</span><span class=n>Issue</span><span class=o>::</span><span class=n>getId</span><span class=o>,</span> <span class=n>issueId</span><span class=o>));</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=n>CollUtil</span><span class=o>.</span><span class=na>isEmpty</span><span class=o>(</span><span class=n>issuesInTargetLane</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=c1>//1.如果目标泳道是空的,直接插入,sort值为1
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=c1>//注意！！！updateIssueSortInSourceLane和issue.setSort顺序不能乱！！！因为updateIssueSortInSourceLane里要和原来的sort比较
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>updateIssueSortInSourceLane</span><span class=o>(</span><span class=n>projectId</span><span class=o>,</span> <span class=n>sprintId</span><span class=o>,</span> <span class=n>sourceLane</span><span class=o>,</span> <span class=n>issue</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=n>issue</span><span class=o>.</span><span class=na>setSort</span><span class=o>(</span><span class=n>1</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=n>issueService</span><span class=o>.</span><span class=na>updateById</span><span class=o>(</span><span class=n>issue</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=c1>//2.如果目标泳道不是空的,则找到被拖工作项最终的归属
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=c1>//先找同泳道内的父亲
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>String</span> <span class=n>parentId</span> <span class=o>=</span> <span class=n>issue</span><span class=o>.</span><span class=na>getParentId</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>Issue</span> <span class=n>parentIssue</span> <span class=o>=</span> <span class=n>issueService</span><span class=o>.</span><span class=na>getOne</span><span class=o>(</span><span class=k>new</span> <span class=n>LambdaQueryWrapper</span><span class=o>&lt;</span><span class=n>Issue</span><span class=o>&gt;().</span><span class=na>eq</span><span class=o>(</span><span class=n>Issue</span><span class=o>::</span><span class=n>getProjectId</span><span class=o>,</span> <span class=n>projectId</span><span class=o>)</span>
</span></span><span class=line><span class=cl>                <span class=o>.</span><span class=na>in</span><span class=o>(</span><span class=n>Issue</span><span class=o>::</span><span class=n>getStateId</span><span class=o>,</span> <span class=n>stateIdsInTargetLane</span><span class=o>)</span>
</span></span><span class=line><span class=cl>                <span class=o>.</span><span class=na>eq</span><span class=o>(</span><span class=n>StrUtil</span><span class=o>.</span><span class=na>isNotEmpty</span><span class=o>(</span><span class=n>sprintId</span><span class=o>),</span> <span class=n>Issue</span><span class=o>::</span><span class=n>getSprintId</span><span class=o>,</span> <span class=n>sprintId</span><span class=o>)</span>
</span></span><span class=line><span class=cl>                <span class=o>.</span><span class=na>isNull</span><span class=o>(</span><span class=n>StrUtil</span><span class=o>.</span><span class=na>isEmpty</span><span class=o>(</span><span class=n>sprintId</span><span class=o>),</span> <span class=n>Issue</span><span class=o>::</span><span class=n>getSprintId</span><span class=o>).</span><span class=na>eq</span><span class=o>(</span><span class=n>Issue</span><span class=o>::</span><span class=n>getId</span><span class=o>,</span> <span class=n>parentId</span><span class=o>));</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=n>StringUtils</span><span class=o>.</span><span class=na>isBlank</span><span class=o>(</span><span class=n>parentId</span><span class=o>)</span> <span class=o>||</span> <span class=n>Objects</span><span class=o>.</span><span class=na>isNull</span><span class=o>(</span><span class=n>parentIssue</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=c1>//根本没有父亲，或者父亲不在泳道内,则看是否在泳道内有子嗣
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>List</span><span class=o>&lt;</span><span class=n>Issue</span><span class=o>&gt;</span> <span class=n>descendants</span> <span class=o>=</span> <span class=n>listFamily</span><span class=o>(</span><span class=n>issueId</span><span class=o>,</span> <span class=n>sprintId</span><span class=o>,</span> <span class=n>stateIdsInTargetLane</span><span class=o>,</span> <span class=kc>false</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=o>(</span><span class=n>CollUtil</span><span class=o>.</span><span class=na>isEmpty</span><span class=o>(</span><span class=n>descendants</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=c1>//在泳道内无依无靠（上无祖先，下无子嗣）则插入到最后,issues每个工作项的sort值都要+1
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=n>issuesInTargetLane</span><span class=o>.</span><span class=na>forEach</span><span class=o>(</span><span class=n>item</span> <span class=o>-&gt;</span> <span class=n>item</span><span class=o>.</span><span class=na>setSort</span><span class=o>(</span><span class=n>item</span><span class=o>.</span><span class=na>getSort</span><span class=o>()</span> <span class=o>+</span> <span class=n>1</span><span class=o>));</span>
</span></span><span class=line><span class=cl>                <span class=n>updateIssueSortInSourceLane</span><span class=o>(</span><span class=n>projectId</span><span class=o>,</span> <span class=n>sprintId</span><span class=o>,</span> <span class=n>sourceLane</span><span class=o>,</span> <span class=n>issue</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                <span class=n>issue</span><span class=o>.</span><span class=na>setSort</span><span class=o>(</span><span class=n>1</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                <span class=n>issuesInTargetLane</span><span class=o>.</span><span class=na>add</span><span class=o>(</span><span class=n>issue</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=o>(</span><span class=n>CollUtil</span><span class=o>.</span><span class=na>isNotEmpty</span><span class=o>(</span><span class=n>issuesInTargetLane</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=n>issueService</span><span class=o>.</span><span class=na>updateBatchById</span><span class=o>(</span><span class=n>issuesInTargetLane</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                <span class=o>}</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=c1>//有后代，放在后代前面，找出后代最大的sort值，大于sort值的issue，全都+1，然后插入到该sort值+1的位置
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=kt>int</span> <span class=n>maxSort</span> <span class=o>=</span> <span class=n>descendants</span><span class=o>.</span><span class=na>stream</span><span class=o>().</span><span class=na>mapToInt</span><span class=o>(</span><span class=n>Issue</span><span class=o>::</span><span class=n>getSort</span><span class=o>).</span><span class=na>max</span><span class=o>().</span><span class=na>orElse</span><span class=o>(</span><span class=n>1</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=n>issuesInTargetLane</span><span class=o>.</span><span class=na>stream</span><span class=o>().</span><span class=na>filter</span><span class=o>(</span><span class=n>item</span> <span class=o>-&gt;</span> <span class=n>item</span><span class=o>.</span><span class=na>getSort</span><span class=o>()</span> <span class=o>&gt;</span> <span class=n>maxSort</span><span class=o>)</span>
</span></span><span class=line><span class=cl>                    <span class=o>.</span><span class=na>forEach</span><span class=o>(</span><span class=n>item</span> <span class=o>-&gt;</span> <span class=n>item</span><span class=o>.</span><span class=na>setSort</span><span class=o>(</span><span class=n>item</span><span class=o>.</span><span class=na>getSort</span><span class=o>()</span> <span class=o>+</span> <span class=n>1</span><span class=o>));</span>
</span></span><span class=line><span class=cl>            <span class=n>updateIssueSortInSourceLane</span><span class=o>(</span><span class=n>projectId</span><span class=o>,</span> <span class=n>sprintId</span><span class=o>,</span> <span class=n>sourceLane</span><span class=o>,</span> <span class=n>issue</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=n>issue</span><span class=o>.</span><span class=na>setSort</span><span class=o>(</span><span class=n>maxSort</span> <span class=o>+</span> <span class=n>1</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=n>issuesInTargetLane</span><span class=o>.</span><span class=na>add</span><span class=o>(</span><span class=n>issue</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=o>(</span><span class=n>CollUtil</span><span class=o>.</span><span class=na>isNotEmpty</span><span class=o>(</span><span class=n>issuesInTargetLane</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>issueService</span><span class=o>.</span><span class=na>updateBatchById</span><span class=o>(</span><span class=n>issuesInTargetLane</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=c1>//有同一泳道的父亲,挂在父亲后面
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>List</span><span class=o>&lt;</span><span class=n>Issue</span><span class=o>&gt;</span> <span class=n>siblings</span> <span class=o>=</span> <span class=n>issueService</span><span class=o>.</span><span class=na>list</span><span class=o>(</span><span class=k>new</span> <span class=n>LambdaQueryWrapper</span><span class=o>&lt;</span><span class=n>Issue</span><span class=o>&gt;().</span><span class=na>eq</span><span class=o>(</span><span class=n>Issue</span><span class=o>::</span><span class=n>getParentId</span><span class=o>,</span> <span class=n>parentId</span><span class=o>)</span>
</span></span><span class=line><span class=cl>                <span class=o>.</span><span class=na>in</span><span class=o>(</span><span class=n>Issue</span><span class=o>::</span><span class=n>getStateId</span><span class=o>,</span> <span class=n>stateIdsInTargetLane</span><span class=o>)</span>
</span></span><span class=line><span class=cl>                <span class=c1>//排除掉自己
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=o>.</span><span class=na>ne</span><span class=o>(</span><span class=n>Issue</span><span class=o>::</span><span class=n>getId</span><span class=o>,</span> <span class=n>issueId</span><span class=o>).</span><span class=na>in</span><span class=o>(</span><span class=n>Issue</span><span class=o>::</span><span class=n>getProjectId</span><span class=o>,</span> <span class=n>projectId</span><span class=o>));</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=n>CollUtil</span><span class=o>.</span><span class=na>isEmpty</span><span class=o>(</span><span class=n>siblings</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=c1>//没有兄弟,则跟在父亲后面,所有大于等于父亲的sort值都要+1,自己占据父亲原来的位置
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>updateIssueSortInSourceLane</span><span class=o>(</span><span class=n>projectId</span><span class=o>,</span> <span class=n>sprintId</span><span class=o>,</span> <span class=n>sourceLane</span><span class=o>,</span> <span class=n>issue</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=n>insertAfter</span><span class=o>(</span><span class=n>issuesInTargetLane</span><span class=o>,</span> <span class=n>issue</span><span class=o>,</span> <span class=n>parentIssue</span><span class=o>.</span><span class=na>getSort</span><span class=o>());</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=c1>//有兄弟,则挂在最后一个兄弟后面,查询出最小sort值的兄弟,自己占据最小兄弟的位置,其他大于等于最小兄弟的sort值都要+1
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>Issue</span> <span class=n>minSibling</span> <span class=o>=</span> <span class=n>siblings</span><span class=o>.</span><span class=na>stream</span><span class=o>().</span><span class=na>min</span><span class=o>(</span><span class=n>Comparator</span><span class=o>.</span><span class=na>comparing</span><span class=o>(</span><span class=n>Issue</span><span class=o>::</span><span class=n>getSort</span><span class=o>)).</span><span class=na>get</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=c1>//最后,把源泳道里大于等于源工作项的sort值都要-1
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>updateIssueSortInSourceLane</span><span class=o>(</span><span class=n>projectId</span><span class=o>,</span> <span class=n>sprintId</span><span class=o>,</span> <span class=n>sourceLane</span><span class=o>,</span> <span class=n>issue</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>insertAfter</span><span class=o>(</span><span class=n>issuesInTargetLane</span><span class=o>,</span> <span class=n>issue</span><span class=o>,</span> <span class=n>minSibling</span><span class=o>.</span><span class=na>getSort</span><span class=o>());</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 插入到targetSort的位置,大于等于targetSort的sort值都要+1
</span></span></span><span class=line><span class=cl><span class=cm>     *
</span></span></span><span class=line><span class=cl><span class=cm>     * @param issuesInTargetLane 目标泳道的工作项集合
</span></span></span><span class=line><span class=cl><span class=cm>     * @param issue              插入的工作项
</span></span></span><span class=line><span class=cl><span class=cm>     * @param targetSort         插入的目标位置
</span></span></span><span class=line><span class=cl><span class=cm>     */</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kt>void</span> <span class=nf>insertAfter</span><span class=o>(</span><span class=n>List</span><span class=o>&lt;</span><span class=n>Issue</span><span class=o>&gt;</span> <span class=n>issuesInTargetLane</span><span class=o>,</span> <span class=n>Issue</span> <span class=n>issue</span><span class=o>,</span> <span class=n>Integer</span> <span class=n>targetSort</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>//插入到目标工作项后面
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>issue</span><span class=o>.</span><span class=na>setSort</span><span class=o>(</span><span class=n>targetSort</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>issuesInTargetLane</span><span class=o>.</span><span class=na>stream</span><span class=o>().</span><span class=na>filter</span><span class=o>(</span><span class=n>item</span> <span class=o>-&gt;</span> <span class=n>item</span><span class=o>.</span><span class=na>getSort</span><span class=o>()</span> <span class=o>&gt;=</span> <span class=n>targetSort</span><span class=o>)</span>
</span></span><span class=line><span class=cl>                <span class=o>.</span><span class=na>forEach</span><span class=o>(</span><span class=n>item</span> <span class=o>-&gt;</span> <span class=n>item</span><span class=o>.</span><span class=na>setSort</span><span class=o>(</span><span class=n>item</span><span class=o>.</span><span class=na>getSort</span><span class=o>()</span> <span class=o>+</span> <span class=n>1</span><span class=o>));</span>
</span></span><span class=line><span class=cl>        <span class=n>issuesInTargetLane</span><span class=o>.</span><span class=na>add</span><span class=o>(</span><span class=n>issue</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=n>CollUtil</span><span class=o>.</span><span class=na>isNotEmpty</span><span class=o>(</span><span class=n>issuesInTargetLane</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>issueService</span><span class=o>.</span><span class=na>updateBatchById</span><span class=o>(</span><span class=n>issuesInTargetLane</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 查询此issueId下的所有工作项和子工作项
</span></span></span><span class=line><span class=cl><span class=cm>     * 不包括epic和feature，因为epic和feature不会在泳道中显示，不参与排序
</span></span></span><span class=line><span class=cl><span class=cm>     *
</span></span></span><span class=line><span class=cl><span class=cm>     * @param issueId     祖先
</span></span></span><span class=line><span class=cl><span class=cm>     * @param sprintId    迭代id
</span></span></span><span class=line><span class=cl><span class=cm>     * @param stateIds    泳道里的状态
</span></span></span><span class=line><span class=cl><span class=cm>     * @param includeSelf 返回的结果是否包括祖先自己
</span></span></span><span class=line><span class=cl><span class=cm>     * @return 家族
</span></span></span><span class=line><span class=cl><span class=cm>     */</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=n>List</span><span class=o>&lt;</span><span class=n>Issue</span><span class=o>&gt;</span> <span class=nf>listFamily</span><span class=o>(</span><span class=n>String</span> <span class=n>issueId</span><span class=o>,</span> <span class=n>String</span> <span class=n>sprintId</span><span class=o>,</span> <span class=n>Set</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span> <span class=n>stateIds</span><span class=o>,</span> <span class=kt>boolean</span> <span class=n>includeSelf</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>List</span><span class=o>&lt;</span><span class=n>Issue</span><span class=o>&gt;</span> <span class=n>result</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ArrayList</span><span class=o>&lt;&gt;();</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=n>StringUtils</span><span class=o>.</span><span class=na>isEmpty</span><span class=o>(</span><span class=n>issueId</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>result</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=n>includeSelf</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>List</span><span class=o>&lt;</span><span class=n>Issue</span><span class=o>&gt;</span> <span class=n>self</span> <span class=o>=</span> <span class=n>issueMapper</span><span class=o>.</span><span class=na>listIssue</span><span class=o>(</span>
</span></span><span class=line><span class=cl>                    <span class=k>new</span> <span class=n>LambdaQueryWrapper</span><span class=o>&lt;</span><span class=n>Issue</span><span class=o>&gt;().</span><span class=na>eq</span><span class=o>(</span><span class=n>Issue</span><span class=o>::</span><span class=n>getId</span><span class=o>,</span> <span class=n>issueId</span><span class=o>).</span><span class=na>in</span><span class=o>(</span><span class=n>Issue</span><span class=o>::</span><span class=n>getStateId</span><span class=o>,</span> <span class=n>stateIds</span><span class=o>)</span>
</span></span><span class=line><span class=cl>                            <span class=o>.</span><span class=na>eq</span><span class=o>(</span><span class=n>StrUtil</span><span class=o>.</span><span class=na>isNotEmpty</span><span class=o>(</span><span class=n>sprintId</span><span class=o>),</span> <span class=n>Issue</span><span class=o>::</span><span class=n>getSprintId</span><span class=o>,</span> <span class=n>sprintId</span><span class=o>)</span>
</span></span><span class=line><span class=cl>                            <span class=o>.</span><span class=na>isNull</span><span class=o>(</span><span class=n>StrUtil</span><span class=o>.</span><span class=na>isEmpty</span><span class=o>(</span><span class=n>sprintId</span><span class=o>),</span> <span class=n>Issue</span><span class=o>::</span><span class=n>getSprintId</span><span class=o>)</span>
</span></span><span class=line><span class=cl>                            <span class=o>.</span><span class=na>notIn</span><span class=o>(</span><span class=n>Issue</span><span class=o>::</span><span class=n>getType</span><span class=o>,</span> <span class=n>IssueTypeEnum</span><span class=o>.</span><span class=na>ISSUE_TYPE_NO_NEED_SORT</span><span class=o>));</span>
</span></span><span class=line><span class=cl>            <span class=n>result</span><span class=o>.</span><span class=na>addAll</span><span class=o>(</span><span class=n>self</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=n>List</span><span class=o>&lt;</span><span class=n>Issue</span><span class=o>&gt;</span> <span class=n>children</span> <span class=o>=</span> <span class=n>issueMapper</span><span class=o>.</span><span class=na>listIssue</span><span class=o>(</span>
</span></span><span class=line><span class=cl>                <span class=k>new</span> <span class=n>LambdaQueryWrapper</span><span class=o>&lt;</span><span class=n>Issue</span><span class=o>&gt;().</span><span class=na>in</span><span class=o>(</span><span class=n>Issue</span><span class=o>::</span><span class=n>getParentId</span><span class=o>,</span> <span class=n>issueId</span><span class=o>).</span><span class=na>in</span><span class=o>(</span><span class=n>Issue</span><span class=o>::</span><span class=n>getStateId</span><span class=o>,</span> <span class=n>stateIds</span><span class=o>)</span>
</span></span><span class=line><span class=cl>                        <span class=o>.</span><span class=na>eq</span><span class=o>(</span><span class=n>StrUtil</span><span class=o>.</span><span class=na>isNotEmpty</span><span class=o>(</span><span class=n>sprintId</span><span class=o>),</span> <span class=n>Issue</span><span class=o>::</span><span class=n>getSprintId</span><span class=o>,</span> <span class=n>sprintId</span><span class=o>)</span>
</span></span><span class=line><span class=cl>                        <span class=o>.</span><span class=na>isNull</span><span class=o>(</span><span class=n>StrUtil</span><span class=o>.</span><span class=na>isEmpty</span><span class=o>(</span><span class=n>sprintId</span><span class=o>),</span> <span class=n>Issue</span><span class=o>::</span><span class=n>getSprintId</span><span class=o>)</span>
</span></span><span class=line><span class=cl>                        <span class=o>.</span><span class=na>notIn</span><span class=o>(</span><span class=n>Issue</span><span class=o>::</span><span class=n>getType</span><span class=o>,</span> <span class=n>IssueTypeEnum</span><span class=o>.</span><span class=na>ISSUE_TYPE_NO_NEED_SORT</span><span class=o>));</span>
</span></span><span class=line><span class=cl>        <span class=n>result</span><span class=o>.</span><span class=na>addAll</span><span class=o>(</span><span class=n>children</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=n>CollUtil</span><span class=o>.</span><span class=na>isNotEmpty</span><span class=o>(</span><span class=n>children</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>List</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span> <span class=n>childrenIds</span> <span class=o>=</span> <span class=n>children</span><span class=o>.</span><span class=na>stream</span><span class=o>().</span><span class=na>map</span><span class=o>(</span><span class=n>Issue</span><span class=o>::</span><span class=n>getId</span><span class=o>).</span><span class=na>collect</span><span class=o>(</span><span class=n>Collectors</span><span class=o>.</span><span class=na>toList</span><span class=o>());</span>
</span></span><span class=line><span class=cl>            <span class=n>List</span><span class=o>&lt;</span><span class=n>Issue</span><span class=o>&gt;</span> <span class=n>grandChildren</span> <span class=o>=</span> <span class=n>issueMapper</span><span class=o>.</span><span class=na>listIssue</span><span class=o>(</span>
</span></span><span class=line><span class=cl>                    <span class=k>new</span> <span class=n>LambdaQueryWrapper</span><span class=o>&lt;</span><span class=n>Issue</span><span class=o>&gt;().</span><span class=na>in</span><span class=o>(</span><span class=n>Issue</span><span class=o>::</span><span class=n>getParentId</span><span class=o>,</span> <span class=n>childrenIds</span><span class=o>).</span><span class=na>in</span><span class=o>(</span><span class=n>Issue</span><span class=o>::</span><span class=n>getStateId</span><span class=o>,</span> <span class=n>stateIds</span><span class=o>)</span>
</span></span><span class=line><span class=cl>                            <span class=o>.</span><span class=na>eq</span><span class=o>(</span><span class=n>StrUtil</span><span class=o>.</span><span class=na>isNotEmpty</span><span class=o>(</span><span class=n>sprintId</span><span class=o>),</span> <span class=n>Issue</span><span class=o>::</span><span class=n>getSprintId</span><span class=o>,</span> <span class=n>sprintId</span><span class=o>)</span>
</span></span><span class=line><span class=cl>                            <span class=o>.</span><span class=na>isNull</span><span class=o>(</span><span class=n>StrUtil</span><span class=o>.</span><span class=na>isEmpty</span><span class=o>(</span><span class=n>sprintId</span><span class=o>),</span> <span class=n>Issue</span><span class=o>::</span><span class=n>getSprintId</span><span class=o>)</span>
</span></span><span class=line><span class=cl>                            <span class=o>.</span><span class=na>notIn</span><span class=o>(</span><span class=n>Issue</span><span class=o>::</span><span class=n>getType</span><span class=o>,</span> <span class=n>IssueTypeEnum</span><span class=o>.</span><span class=na>ISSUE_TYPE_NO_NEED_SORT</span><span class=o>));</span>
</span></span><span class=line><span class=cl>            <span class=n>result</span><span class=o>.</span><span class=na>addAll</span><span class=o>(</span><span class=n>grandChildren</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>result</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 更新原泳道中的issue排序
</span></span></span><span class=line><span class=cl><span class=cm>     *
</span></span></span><span class=line><span class=cl><span class=cm>     * @param projectId  项目id
</span></span></span><span class=line><span class=cl><span class=cm>     * @param sprintId   迭代id
</span></span></span><span class=line><span class=cl><span class=cm>     * @param sourceLane 源泳道
</span></span></span><span class=line><span class=cl><span class=cm>     * @param issue      拖拽出去的工作项
</span></span></span><span class=line><span class=cl><span class=cm>     */</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kt>void</span> <span class=nf>updateIssueSortInSourceLane</span><span class=o>(</span><span class=n>String</span> <span class=n>projectId</span><span class=o>,</span> <span class=n>String</span> <span class=n>sprintId</span><span class=o>,</span> <span class=n>SprintLane</span> <span class=n>sourceLane</span><span class=o>,</span> <span class=n>Issue</span> <span class=n>issue</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>List</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span> <span class=n>stateIdsInSourceLane</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>                <span class=n>Arrays</span><span class=o>.</span><span class=na>stream</span><span class=o>(</span><span class=n>sourceLane</span><span class=o>.</span><span class=na>getStateIds</span><span class=o>().</span><span class=na>split</span><span class=o>(</span><span class=s>&#34;,&#34;</span><span class=o>)).</span><span class=na>collect</span><span class=o>(</span><span class=n>Collectors</span><span class=o>.</span><span class=na>toList</span><span class=o>());</span>
</span></span><span class=line><span class=cl>        <span class=n>List</span><span class=o>&lt;</span><span class=n>Issue</span><span class=o>&gt;</span> <span class=n>issuesInSourceLane</span> <span class=o>=</span> <span class=n>issueMapper</span><span class=o>.</span><span class=na>listIssue</span><span class=o>(</span>
</span></span><span class=line><span class=cl>                <span class=k>new</span> <span class=n>LambdaQueryWrapper</span><span class=o>&lt;</span><span class=n>Issue</span><span class=o>&gt;().</span><span class=na>in</span><span class=o>(</span><span class=n>Issue</span><span class=o>::</span><span class=n>getStateId</span><span class=o>,</span> <span class=n>stateIdsInSourceLane</span><span class=o>)</span>
</span></span><span class=line><span class=cl>                        <span class=o>.</span><span class=na>in</span><span class=o>(</span><span class=n>Issue</span><span class=o>::</span><span class=n>getProjectId</span><span class=o>,</span> <span class=n>projectId</span><span class=o>)</span>
</span></span><span class=line><span class=cl>                        <span class=o>.</span><span class=na>eq</span><span class=o>(</span><span class=n>StrUtil</span><span class=o>.</span><span class=na>isNotEmpty</span><span class=o>(</span><span class=n>sprintId</span><span class=o>),</span> <span class=n>Issue</span><span class=o>::</span><span class=n>getSprintId</span><span class=o>,</span> <span class=n>sprintId</span><span class=o>)</span>
</span></span><span class=line><span class=cl>                        <span class=o>.</span><span class=na>isNull</span><span class=o>(</span><span class=n>StrUtil</span><span class=o>.</span><span class=na>isEmpty</span><span class=o>(</span><span class=n>sprintId</span><span class=o>),</span> <span class=n>Issue</span><span class=o>::</span><span class=n>getSprintId</span><span class=o>)</span>
</span></span><span class=line><span class=cl>                        <span class=o>.</span><span class=na>notIn</span><span class=o>(</span><span class=n>Issue</span><span class=o>::</span><span class=n>getType</span><span class=o>,</span> <span class=n>IssueTypeEnum</span><span class=o>.</span><span class=na>ISSUE_TYPE_NO_NEED_SORT</span><span class=o>));</span>
</span></span><span class=line><span class=cl>        <span class=c1>//大于等于拖拽出去的工作项的sort值都要-1
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>issuesInSourceLane</span><span class=o>.</span><span class=na>forEach</span><span class=o>(</span><span class=n>item</span> <span class=o>-&gt;</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=o>(</span><span class=n>item</span><span class=o>.</span><span class=na>getSort</span><span class=o>()</span> <span class=o>&gt;=</span> <span class=n>issue</span><span class=o>.</span><span class=na>getSort</span><span class=o>()</span> <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=n>item</span><span class=o>.</span><span class=na>getId</span><span class=o>().</span><span class=na>equals</span><span class=o>(</span><span class=n>issue</span><span class=o>.</span><span class=na>getId</span><span class=o>()))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>item</span><span class=o>.</span><span class=na>setSort</span><span class=o>(</span><span class=n>item</span><span class=o>.</span><span class=na>getSort</span><span class=o>()</span> <span class=o>-</span> <span class=n>1</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>});</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=n>CollUtil</span><span class=o>.</span><span class=na>isNotEmpty</span><span class=o>(</span><span class=n>issuesInSourceLane</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>issueService</span><span class=o>.</span><span class=na>updateBatchById</span><span class=o>(</span><span class=n>issuesInSourceLane</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span></code></pre></div></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>更新于 2023-09-22</span></div><div class=post-info-license></div></div><div class=post-info-line><div class=post-info-md></div><div class=post-info-share><span></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fas fa-tags fa-fw"></i>&nbsp;<a href=/tags/%E7%AE%97%E6%B3%95/>算法</a></section><section><span><a href=javascript:void(0); onclick=window.history.back()>返回</a></span>&nbsp;|&nbsp;<span><a href=/>主页</a></span></section></div><div class=post-nav><a href=/posts/install-clash-on-linux/ class=prev rel=prev title="Deepin安装Clash for Windows"><i class="fas fa-angle-left fa-fw"></i>Deepin安装Clash for Windows</a></div></div><div id=comments><div id=utterances></div><noscript>Please enable JavaScript to view the comments powered by <a href=https://utteranc.es/>Utterances</a>.</noscript></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line>由 <a href=https://gohugo.io/ target=_blank rel="noopener noreffer" title="Hugo 0.118.2">Hugo</a> 强力驱动 | 主题 - <a href=https://github.com/dillonzq/LoveIt target=_blank rel="noopener noreffer" title="LoveIt 0.2.10"><i class="far fa-kiss-wink-heart fa-fw"></i> LoveIt</a></div><div class=footer-line><i class="far fa-copyright fa-fw"></i><span itemprop=copyrightYear>2023</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=/ target=_blank>boatrain</a></span></div></div></footer></div><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title=回到顶部><i class="fas fa-arrow-up fa-fw"></i>
</a><a href=# id=view-comments class=fixed-button title=查看评论><i class="fas fa-comment fa-fw"></i></a></div><link rel=stylesheet href=/lib/lightgallery/lightgallery.min.css><link rel=stylesheet href=/lib/katex/katex.min.css><script type=text/javascript src=/lib/smooth-scroll/smooth-scroll.min.js></script><script type=text/javascript src=/lib/lazysizes/lazysizes.min.js></script><script type=text/javascript src=/lib/lightgallery/lightgallery.min.js></script><script type=text/javascript src=/lib/lightgallery/lg-thumbnail.min.js></script><script type=text/javascript src=/lib/lightgallery/lg-zoom.min.js></script><script type=text/javascript src=/lib/clipboard/clipboard.min.js></script><script type=text/javascript src=/lib/katex/katex.min.js></script><script type=text/javascript src=/lib/katex/auto-render.min.js></script><script type=text/javascript>window.config={code:{copyTitle:"复制到剪贴板",maxShownLines:10},comment:{utterances:{darkTheme:"github-dark",issueTerm:"pathname",label:"Comment",lightTheme:"github-light",repo:"boatrainlsz/blog-comment"}},lightGallery:{actualSize:!1,exThumbImage:"data-thumbnail",hideBarsDelay:2e3,selector:".lightgallery",speed:400,thumbContHeight:80,thumbWidth:80,thumbnail:!0},math:{delimiters:[{display:!0,left:"$$",right:"$$"},{display:!0,left:"\\[",right:"\\]"},{display:!1,left:"$",right:"$"},{display:!1,left:"\\(",right:"\\)"}],strict:!1}}</script><script type=text/javascript src=/js/theme.min.js></script><script type=text/javascript>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-SLGEHM7PTD")</script><script type=text/javascript src="https://www.googletagmanager.com/gtag/js?id=G-SLGEHM7PTD" async></script></body></html>